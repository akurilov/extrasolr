buildscript {
    repositories {
        mavenCentral()
        gradlePluginPortal()
    }
}

plugins {
    id "java"
    id "com.bmuschko.docker-remote-api" version "6.0.0"
}

repositories {
    mavenCentral()
}

dependencies {
    compile("com.squareup.okhttp3:okhttp:${okHttpVersion}")
    compile("io.nats:jnats:${natsVersion}")
    compile("org.apache.solr:solr-solrj:${solrVersion}")
    compile("net.htmlparser.jericho:jericho-html:3.4")
    compile("org.apache.commons:commons-collections4:4.4")
    compile("org.slf4j:slf4j-simple:1.7.24")
    testCompile("org.junit.jupiter:junit-jupiter:5.5.1")
}

java {
    sourceCompatibility = JavaVersion.VERSION_11
    targetCompatibility = JavaVersion.VERSION_11
}

tasks {
    wrapper {
        gradleVersion = "6.0"
    }
    jar {
        from configurations.compile.collect {
            it.isDirectory() ? it : zipTree(it)
        }
    }
    test {
        useJUnitPlatform()
        testLogging {
            events("passed", "skipped", "failed")
        }
    }
}

import com.bmuschko.gradle.docker.tasks.image.*

task dockerBuildImage(type: DockerBuildImage, dependsOn: jar) {
    inputDir = project.projectDir
    buildArgs = [
        "NATS_VERSION": natsVersion,
        "SOLR_VERSION": solrVersion,
    ]
    dockerFile = project.file("ci${File.separator}docker${File.separator}Dockerfile")
    imageId = "akurilov/${project.name}".toString()
}

task dockerTagImage(type: DockerTagImage, dependsOn: dockerBuildImage) {
    imageId = dockerBuildImage.imageId
    tag = "latest"
    repository = "akurilov/${project.name}"
}
